name: Generate Section for File upload
run-name: auto-deployed by ${{ github.actor }}
on:
  push:
    paths:
      - 'files/**'

jobs:
  update-index:
    runs-on: ubuntu-latest
    permissions:
      write-all
    steps:
    - name: checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Debug - Git Info
      run: |
          echo "=== GIT LOG ==="
          git log --oneline -10
          echo ""
          echo "=== GITHUB EVENT INFO ==="
          echo "github.event.before: ${{ github.event.before }}"
          echo "github.event.after: ${{ github.event.after }}"
          echo ""
          echo "=== GIT DIFF OUTPUT ==="
          git diff --name-only ${{ github.event.before }} ${{ github.event.after }} -- files/
          echo ""
          echo "=== ALL CHANGED FILES ==="
          git diff --name-only ${{ github.event.before }} ${{ github.event.after }}

    - name: Get added files
      id: files
      run: |
          echo "Step: Getting files from git diff"
          FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.event.after }} -- files/)
          
          if [ -z "$FILES" ]; then
            echo "WARNING: No files detected in files/ directory"
          else
            echo "Files detected:"
            echo "$FILES"
          fi
          
          echo "FILES<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Check files variable
      run: |
          echo "=== CHECKING FILES OUTPUT ==="
          echo "Raw output:"
          echo "${{ steps.files.outputs.FILES }}"
          echo ""
          echo "Length: ${#FILES}"

    - name: Update index.html
      run: |
          echo "=== STARTING INDEX.HTML UPDATE ==="
          echo "Files to process:"
          echo "${{ steps.files.outputs.FILES }}"
          echo "---"
          
          COUNTER=0
          while IFS= read -r file
          do
            COUNTER=$((COUNTER + 1))
            echo ""
            echo "[$COUNTER] Processing line: '$file'"
            
            if [ -z "$file" ]; then
              echo "  → Skipping empty line"
              continue
            fi
            
            filename=$(basename "$file")
            echo "  → Full path: $file"
            echo "  → Filename: $filename"
            
            block="<div class='rounded'><a href=\"$file\">$filename</a></div>"
            echo "  → Block HTML: $block"

            if [[ "$filename" == 1-* ]]; then
              echo "  → ✓ Matches 1-* pattern"
              echo "  → Executing: sed -i \"/<h3 id='newc'>/i $block\" index.html"
              sed -i "/<h3 id='newc'>/i $block" index.html
            elif [[ "$filename" == 2-* ]]; then
              echo "  → ✓ Matches 2-* pattern"
              echo "  → Executing: sed -i \"/<\/body>/i $block\" index.html"
              sed -i "/<\/body>/i $block" index.html
            else
              echo "  → ✗ No pattern match (doesn't start with 1- or 2-)"
            fi
          done <<< "${{ steps.files.outputs.FILES }}"
          
          echo ""
          echo "Total lines processed: $COUNTER"
          echo ""
          echo "=== FINAL index.html ==="
          cat index.html

    - name: Git status
      run: |
          echo "=== GIT STATUS ==="
          git status
          echo ""
          echo "=== GIT DIFF ==="
          git diff index.html

    - name: Commit changes
      run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add index.html
          git commit -m "Deploy new section(s) for new uploaded file(s)" || echo "No changes to commit"
          git push
